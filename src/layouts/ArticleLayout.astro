---
import BaseLayout from './BaseLayout.astro';
import BlogDisclaimer from '../components/BlogDisclaimer.astro';
import { calculateReadingTime, formatReadingTime } from '../utils/readingTime';

interface Props {
  title: string;
  description: string;
  heroImage?: string;
  pubDate: Date;
  updatedDate?: Date;
  content?: string;
  category?: string;
  slug?: string;
  author?: string;
}

const { title, description, heroImage, pubDate, updatedDate, content = '', category, slug, author } = Astro.props;

const readingTime = content ? formatReadingTime(calculateReadingTime(content)) : null;
const canonicalURL = Astro.site ? new URL(`/articles/${slug}`, Astro.site).href : '';
---

<BaseLayout
  title={`${title} — Projexions`}
  description={description}
  currentPath={slug ? `/articles/${slug}` : undefined}
  ogType="article"
>
  <!-- Article structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": title,
    "description": description,
    "datePublished": pubDate.toISOString(),
    "dateModified": updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
    "author": {
      "@type": "Organization",
      "name": "Projexions"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Projexions",
      "url": Astro.site?.href || "https://projexions.com"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": canonicalURL
    },
    ...(category ? { "articleSection": category } : {})
  })} />

  <article class="page-container">
    <header class="post-header">
      <h1 class="serif-heading text-4xl font-semibold mb-4">{title}</h1>
      <p class="text-lg mb-4">{description}</p>
      <div class="post-meta-header">
        {author && <span class="text-sm font-medium">By {author}</span>}
        {author && <span class="text-sm">•</span>}
        <time class="text-sm" datetime={pubDate.toISOString()}>
          {pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        {updatedDate && (
          <time class="text-sm" datetime={updatedDate.toISOString()}>
            Updated {updatedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
        )}
        {category && <span class="text-sm">• {category}</span>}
        {readingTime && <span class="text-sm">• {readingTime}</span>}
      </div>
      <div class="article-share">
        <a
          href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(canonicalURL)}&text=${encodeURIComponent(title)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-button"
          aria-label="Share on X"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          Share
        </a>
      </div>
    </header>

    {heroImage && (
      <div class="hero-image-wrapper">
        <img src={heroImage} alt={title} class="hero-image" />
      </div>
    )}

    <div class="prose-content">
      <slot />
    </div>

    <BlogDisclaimer />
  </article>
</BaseLayout>

<style>
  .post-header {
    margin-bottom: 3rem;
  }

  .post-meta-header {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .hero-image-wrapper {
    margin-bottom: 3rem;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--ui-gray);
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .table-of-contents {
    background-color: var(--bg-section-alt);
    border-left: 3px solid var(--brand-green);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .toc-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-charcoal);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-item a {
    color: var(--text-charcoal);
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .toc-item a:hover {
    color: var(--brand-green);
  }

  .toc-depth-2 {
    padding-left: 0;
  }

  .toc-depth-3 {
    padding-left: 1rem;
    font-size: 0.9375rem;
  }

  .author-bio {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--ui-gray);
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .author-bio-image {
    flex-shrink: 0;
  }

  .author-bio-image img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--ui-gray);
  }

  .author-bio-content {
    flex: 1;
  }

  .author-bio-name {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-charcoal);
  }

  .author-bio-text {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--text-charcoal);
    margin: 0;
  }

  .article-share {
    margin-top: 1.5rem;
  }

  .share-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.875rem;
    background-color: var(--text-charcoal);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: background-color 0.2s ease;
  }

  .share-button:hover {
    background-color: #000;
  }

  .share-button svg {
    flex-shrink: 0;
  }

  @media (max-width: 640px) {
    .author-bio {
      flex-direction: column;
      gap: 1rem;
    }

    .author-bio-image {
      align-self: flex-start;
    }
  }
</style>
